<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Project3_Server/src/Kiosk.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Project3_Server/src/Kiosk.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Kiosk API routes for customer self-service ordering.
 * Provides endpoints for menu retrieval, item purchase, and order management.
 */

import express from 'express';

import Transaction, {Order, Tray} from './Transaction.js';
import Item, {Menu} from './Item.js';
import User, {Employee, Customer} from './User.js';
import { pool } from './db.js';

const kioskRouter = express.Router();
let nextTransactionNum = -1;
let nextOrderNum = -1;

kioskRouter.get('/get-next-transaction-number', async (req, res) => {
    try {
        const result = await pool.query("SELECT transactionid, orderid FROM orders ORDER BY orderid DESC LIMIT 1");
        nextTransactionNum = 1 + result.rows[0].transactionid;
        nextOrderNum = 1 + result.rows[0].orderid;
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Database query failed" });
    }
});

/**
 * GET /get-items
 * Retrieves all available menu items from the database.
 * 
 * @route GET /get-items
 * @returns {Array&lt;Object>} Array of all menu items
 */
kioskRouter.get('/get-items', async (req, res) => {
    try {
        const result = await pool.query("SELECT * FROM items");
        res.json(result.rows);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Database query failed" });
    }
});

/**
 * GET /get-menu
 * Retrieves menu items, optionally filtered by type (entree, side, drink, etc.).
 * 
 * @route GET /get-menu
 * @query {string} [type] - Optional menu type filter
 * @returns {Array&lt;Object>} Array of menu items matching criteria
 */
kioskRouter.get('/get-menu', async (req, res) => {
    try {
        const { type } = req.query;
        const result = type
        ? await pool.query('SELECT * FROM menu WHERE LOWER(type) = LOWER($1)', [type])
        : await pool.query('SELECT * FROM menu');
        res.json(result.rows);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: 'Database query failed' });
    }
});

/**
 * GET /get-sizes
 * Retrieves available size modifiers (small, medium, large).
 * 
 * @route GET /get-sizes
 * @returns {Array&lt;Object>} Array of size modifiers
 */
kioskRouter.get('/get-sizes', async (req, res) => {
    try {
        const result = await pool.query("SELECT * FROM sizemods");
        res.json(result.rows);
    } catch (err) {
        console.error(err);
        res.status(500).json({ error: "Database query failed" });
    }
});

/**
 * POST /submit-order
 * Submits a customer order to the database.
 * Handles inventory updates and creates transaction record.
 * 
 * @route POST /submit-order
 * @body {Object} orderItems - Array of items to order
 * @returns {Object} Transaction confirmation data
 */
kioskRouter.post('/submit-order', async (req, res) => {
    try {
        const now = new Date();
        let transIdRes = await pool.query('SELECT transactionid FROM transactions ORDER BY transactionid DESC');
        if (!transIdRes || !transIdRes.rows || transIdRes.rows.length === 0) {
            throw new Error('Failed to retrieve next transaction ID');
        }
        nextTransactionNum = transIdRes.rows[0].transactionid + 1;
        console.log(nextTransactionNum +"wgeergttwrg5te");
        transIdRes = await pool.query('SELECT orderid FROM orders ORDER BY orderid DESC');
        if (!transIdRes || !transIdRes.rows || transIdRes.rows.length === 0) {
            throw new Error('Failed to retrieve next order ID');
        }
        nextOrderNum = transIdRes.rows[1].orderid;
        const orderData = req.body.orderItems;
        if (!orderData) {
            return res.status(400).json({ error: "Missing order data" });
        }
        let result = '';
        let price = 0;
        let family = false;
        for (const row of orderData) {
            if (row.price) {
                price += row.price;
                nextOrderNum++;
                await pool.query("INSERT INTO orders (transactionid, itemid, orderid) VALUES ($1, $2, $3)", [nextTransactionNum, row.itemid, nextOrderNum]);
                await pool.query("UPDATE inventory AS i SET quantity = i.quantity - 1 FROM items AS it WHERE i.inventoryid = ANY(it.inventoryids) AND it.itemid = " + row.itemid + ";");
                if (row.itemid == 4) {
                    family = true;
                }
                else {
                    family = false;
                }
            }
            else {
                price += row.pricemod;
                if (row.sizeKey == "large") {
                    await pool.query("UPDATE inventory AS i SET quantity = i.quantity - 3 FROM menu AS m WHERE i.inventoryid = ANY(m.inventoryids) AND m.menuid = " + row.menuid + ";");
                    await pool.query("INSERT INTO trays (orderid, menuid, type, size) VALUES ($1, $2, $3, $4)", [nextOrderNum, row.menuid, row.type, "large"]);
                }
                else if (row.sizeKey == "medium") {
                    await pool.query("UPDATE inventory AS i SET quantity = i.quantity - 2 FROM menu AS m WHERE i.inventoryid = ANY(m.inventoryids) AND m.menuid = " + row.menuid + ";");
                    await pool.query("INSERT INTO trays (orderid, menuid, type, size) VALUES ($1, $2, $3, $4)", [nextOrderNum, row.menuid, row.type, "medium"]);
                }
                else if (row.sizeKey == "small") {
                    await pool.query("UPDATE inventory AS i SET quantity = i.quantity - 1 FROM menu AS m WHERE i.inventoryid = ANY(m.inventoryids) AND m.menuid = " + row.menuid + ";");
                    await pool.query("INSERT INTO trays (orderid, menuid, type, size) VALUES ($1, $2, $3, $4)", [nextOrderNum, row.menuid, row.type, "small"]);
                }
                else if (family) {
                    await pool.query("UPDATE inventory AS i SET quantity = i.quantity - 2 FROM menu AS m WHERE i.inventoryid = ANY(m.inventoryids) AND m.menuid = " + row.menuid + ";");
                    await pool.query("INSERT INTO trays (orderid, menuid, type, size) VALUES ($1, $2, $3, $4)", [nextOrderNum, row.menuid, row.type, null]);
                }
                else {
                    await pool.query("UPDATE inventory AS i SET quantity = i.quantity - 1 FROM menu AS m WHERE i.inventoryid = ANY(m.inventoryids) AND m.menuid = " + row.menuid + ";");
                    await pool.query("INSERT INTO trays (orderid, menuid, type, size) VALUES ($1, $2, $3, $4)", [nextOrderNum, row.menuid, row.type, null]);
                }
            }
        }
        let timestamp = now.toISOString().slice(0, 19).replace('T', ' ');
        // if (Number(timestamp.substring(11, 13)) &lt; 6) {
        //     timestamp = timestamp.substring(0, 11) + String(Number(timestamp.substring(11, 13)) + 18) + timestamp.substring(13, 19);
        // }
        // else {
        //     if (String(Number(timestamp.substring(11, 13)) - 6).length == 1) {
        //         timestamp = timestamp.substring(0, 11) + "0" + String(Number(timestamp.substring(11, 13)) - 6) + timestamp.substring(13, 19);
        //     }
        //     else {
        //         timestamp = timestamp.substring(0, 11) + String(Number(timestamp.substring(11, 13)) - 6) + timestamp.substring(13, 19);
        //     }
        // }
        const query = `INSERT INTO transactions (transactionid, employeeid, time, amount, profit, customerid, stage) VALUES ($1, $2, $3, $4, $5, $6, $7)`;
        const values = [nextTransactionNum, -1, timestamp, price, (price * .27).toFixed(2), -1, 4];
        result = await pool.query(query, values);
        console.log("We did it");
        nextTransactionNum++;
        res.json({ transactionid: nextTransactionNum - 1 });

    } catch(err) {
        console.log("We didn't do it");
        console.error(err);
        res.status(500).json({ error: "Failed to process order" });
    }
});

export default kioskRouter;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="CashierMainPage.html">CashierMainPage</a></li><li><a href="Manager.html">Manager</a></li><li><a href="Transaction.html">Transaction</a></li><li><a href="User.html">User</a></li></ul><h3>Global</h3><ul><li><a href="global.html#TranslationContext">TranslationContext</a></li><li><a href="global.html#buildTraySummaries">buildTraySummaries</a></li><li><a href="global.html#chatWithAI">chatWithAI</a></li><li><a href="global.html#clearOrder">clearOrder</a></li><li><a href="global.html#decodeHTMLEntities">decodeHTMLEntities</a></li><li><a href="global.html#loadOrder">loadOrder</a></li><li><a href="global.html#printHistory">printHistory</a></li><li><a href="global.html#saveOrder">saveOrder</a></li><li><a href="global.html#translateMultiple">translateMultiple</a></li><li><a href="global.html#translateText">translateText</a></li><li><a href="global.html#useTranslate">useTranslate</a></li><li><a href="global.html#useTranslatedArray">useTranslatedArray</a></li><li><a href="global.html#useTranslatedObject">useTranslatedObject</a></li><li><a href="global.html#useTranslatedText">useTranslatedText</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Tue Dec 09 2025 19:51:30 GMT-0600 (Central Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
